---
import Layout from './Layout.astro';
import DynamicComponent from '../components/DynamicComponent.astro';
import { getMultilingualContent, detectLanguage } from '../lib/utils/language.js';

interface Props {
  title: string;
  excerpt?: string;
  pageContent?: any[];
  pageDocument?: any; // Full document with multilingual content
  backLinkText?: string;
  backLinkUrl?: string;
}

// Detect current language
const currentLang = detectLanguage(Astro.request);

const {
  title,
  excerpt,
  pageContent = [],
  pageDocument,
  backLinkText = currentLang === 'en' ? "← Back to homepage" : "← Tilbake til forsiden",
  backLinkUrl = currentLang === 'en' ? "/en" : "/"
} = Astro.props;

// Get multilingual content if pageDocument is provided, otherwise use pageContent
const content = pageDocument
  ? (getMultilingualContent(pageDocument) || pageDocument?.content || pageContent)
  : pageContent;

// Extract slug information from pageDocument if available
const slugNo = pageDocument?.slug_no;
const slugEn = pageDocument?.slug_en;
---

<Layout title={`${title} - Sanity + Astro`} slugNo={slugNo} slugEn={slugEn}>
  <main class="container page-layout">
    <header class="page-header">
      <h1 class="page-title">
        {title}
      </h1>
      {excerpt && (
        <p class="page-excerpt">{excerpt}</p>
      )}
    </header>

    <!-- Page content from schema -->
    {content && Array.isArray(content) && content.length > 0 && (
      <div class="page-content">
        {content.map((block) => (
          <DynamicComponent key={block._key || block._id} block={block} />
        ))}
      </div>
    )}

    <!-- Main content slot (for listings, etc.) -->
    <slot />

    <footer class="page-footer">
      <a href={backLinkUrl} class="back-link">
        {backLinkText}
      </a>
    </footer>
  </main>
</Layout>

<style>
  /* Page Layout - Stack Pattern with Flexbox Gap */
  .page-layout {
    display: flex;
    flex-direction: column;
    gap: clamp(var(--space-4), 4vw, var(--space-6));
    padding-block-start: clamp(calc(var(--space-6) * 2.5), 15vw, calc(var(--space-9) * 2.5));
  }

  .page-header {
    margin: 0;
  }

  .page-title {
    margin: 0 0 var(--space-2) 0;
  }

  .page-excerpt {
    margin: var(--space-3) 0 0 0;
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
  }

  .page-content {
    margin: 0;
  }

  .page-footer {
    margin: 0;
    padding-block-start: var(--space-6);
    border-block-start: 1px solid var(--color-border);
  }

  .back-link {
    text-decoration: none;
    font-weight: var(--font-weight-medium);
  }

  /* Remove arrow since back link already has ← at the start */
  .back-link::after {
    content: none;
  }

  .back-link:hover {
    text-decoration: underline;
  }
</style>