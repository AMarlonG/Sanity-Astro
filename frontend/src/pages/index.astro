---
import Layout from '../layouts/Layout.astro';
import { sanityClient } from 'sanity:client';
import PortableText from '../components/PortableText.astro';
import Heading from '../components/Heading.astro';
import Image from '../components/Image.astro';
import Video from '../components/Video.astro';
import Button from '../components/Button.astro';
import Link from '../components/Link.astro';
import Quote from '../components/Quote.astro';
import Accordion from '../components/Accordion.astro';
import ContentScrollContainer from '../components/ContentScrollContainer.astro';
import ArtistScrollContainer from '../components/ArtistScrollContainer.astro';
import EventScrollContainer from '../components/EventScrollContainer.astro';
import Countdown from '../components/Countdown.astro';

// Get Visual Editing perspective
const perspective = Astro.request.headers.get('cookie')?.includes('sanity-preview-mode=true') ? 'drafts' : 'published';

// Load homepage with expanded countdown references
const homepage = await sanityClient.fetch(
  `*[_type == "homepage" && (homePageType == "default" || 
    (homePageType == "scheduled" && 
     scheduledPeriod.startDate <= now() && 
     scheduledPeriod.endDate >= now()))] | order(homePageType desc)[0]{
    _id,
    title,
    homePageType,
    scheduledPeriod,
    content[]{
      ...,
      _type == "countdownComponent" => {
        ...,
        targetEvent->{
          _id,
          title,
          eventDate->{
            date
          },
          eventTime
        }
      },
      _type == "linkComponent" => {
        ...,
        internalLink->{
          _id,
          slug
        }
      }
    }
  }`,
  {},
  {
    perspective,
    useCdn: perspective === 'published',
    token: import.meta.env.SANITY_API_READ_TOKEN,
    stega: import.meta.env.PUBLIC_SANITY_VISUAL_EDITING_ENABLED === 'true'
  }
);

const homepageTitle = homepage?.title || 'Forside';

// Smart caching basert p책 innholdstype
if (homepage?.scheduledPeriod) {
  const timeUntilExpiry = new Date(homepage.scheduledPeriod.endDate).getTime() - Date.now();
  const cacheTime = Math.min(timeUntilExpiry / 1000, 300); // Maks 5 minutter
  
  Astro.response.headers.set('Cache-Control', `public, max-age=${cacheTime}`);
} else {
  Astro.response.headers.set('Cache-Control', 'public, max-age=3600'); // 1 time
}

console.log('Aktiv forside:', homepage);
---

<Layout title={homepageTitle}>
  <main class="container">
    {homepage ? (
      <div>
        <h1>{homepageTitle}</h1>
        
        
        {homepage?.content && Array.isArray(homepage.content) && (
          <div>
            {homepage.content.map((block) => (
              <div key={block._key || block._id}>
                {block._type === 'portableTextBlock' && <PortableText content={block.content} />}
                {block._type === 'headingComponent' && <Heading level={block.level} text={block.text} id={block.id} _key={block._key} _type={block._type} />}
                {block._type === 'imageComponent' && <Image image={block.image} alt={block.alt} caption={block.caption} credit={block.credit} alignment={block.alignment} size={block.size} aspectRatio={block.aspectRatio} _key={block._key} _type={block._type} />}
                {block._type === 'videoComponent' && <Video url={block.url} title={block.title} thumbnail={block.thumbnail} />}
                {block._type === 'buttonComponent' && <Button text={block.text} style={block.style} size={block.size} action={block.action} />}
                {block._type === 'linkComponent' && <Link text={block.text} linkType={block.linkType} internalLink={block.internalLink} url={block.url} email={block.email} phone={block.phone} openInNewTab={block.openInNewTab} accessibility={block.accessibility} />}
                {block._type === 'quoteComponent' && <Quote quote={block.quote} author={block.author} />}
                {block._type === 'accordionComponent' && <Accordion title={block.title} content={block.content} />}
                {block._type === 'contentScrollContainer' && <ContentScrollContainer title={block.title} items={block.items} spacing={block.spacing} />}
                {block._type === 'artistScrollContainer' && <ArtistScrollContainer title={block.title} items={block.items} cardFormat={block.cardFormat} />}
                {block._type === 'eventScrollContainer' && <EventScrollContainer title={block.title} events={block.events} cardFormat={block.cardFormat} />}
                {block._type === 'countdownComponent' && <Countdown targetEvent={block.targetEvent} title={block.title} style={block.style} completedMessage={block.completedMessage} hideWhenComplete={block.hideWhenComplete} />}
                {/* Fallback for ukjent type */}
                {[ 'portableTextBlock', 'headingComponent', 'imageComponent', 'videoComponent', 'buttonComponent', 'linkComponent', 'quoteComponent', 'accordionComponent', 'contentScrollContainer', 'artistScrollContainer', 'eventScrollContainer', 'countdownComponent' ].indexOf(block._type) === -1 && (
                  <div>Ukjent komponent: {block._type}</div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    ) : (
      <div>
        <h1>Velkommen til forsiden</h1>
        <p>Ingen forside er konfigurert enn책. G책 til Sanity Studio for 책 opprette en forside.</p>
      </div>
    )}
  </main>
</Layout>
