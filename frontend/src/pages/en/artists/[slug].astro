---
import Layout from "../../../layouts/Layout.astro";
import DynamicComponent from "../../../components/DynamicComponent.astro";
import { getMultilingualContent } from "../../../lib/utils/language.js";
import { getOptimizedImageUrl, getResponsiveSrcSet, IMAGE_QUALITY, RESPONSIVE_WIDTHS } from '../../../lib/imageHelpers';
import type { SanityDocument } from '@sanity/client';
import { loadQuery } from '../../../lib/sanity/loadQuery.js';

// Generate static paths for all artists
export async function getStaticPaths() {
  const { data: artists } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "artist" && defined(slug.current)]`,
  });

  return artists.map((artist) => {
    return {
      params: {
        slug: artist.slug.current,
      },
    };
  });
}

const { params } = Astro;

// Fetch the specific artist based on the slug parameter
const { data: artist } = await loadQuery({
  query: `*[_type == "artist" && slug.current == $slug][0]{
    _id,
    _type,
    name,
    excerpt_no,
    excerpt_en,
    instrument_no,
    instrument_en,
    "instrument": coalesce(instrument_en, instrument_no),
    country,
    "image": {
      "image": image{
        asset->,
        hotspot,
        crop
      },
      "alt": coalesce(imageAlt_en, imageAlt_no, image.alt),
      "credit": coalesce(imageCredit_en, imageCredit_no)
    },
    "slug": slug.current,
    content_no,
    content_en,
    instagram,
    facebook,
    spotify,
    youtube,
    websiteUrl,
    spotifyUrl,
    instagramUrl,
    seo
  }`,
  params,
});

if (!artist) {
  return Astro.redirect('/404');
}

// Get English content
const content = getMultilingualContent(artist, 'en') || artist.content_en;
---

<Layout title={`${artist.name} - Artist`}>
  <main>
    <nav class="breadcrumb">
      <a href="/en/artists">‚Üê Back to artists</a>
    </nav>

    <article>
      <header>
        <h1>{artist.name}</h1>

        {artist.image?.image && (
          <figure class="artist-image">
            <picture>
              <source
                srcset={getResponsiveSrcSet(artist.image.image, RESPONSIVE_WIDTHS.HERO, IMAGE_QUALITY.HERO)}
                type="image/webp"
                sizes="(max-width: 768px) 100vw, 800px"
              />
              <img
                src={getOptimizedImageUrl(artist.image.image, 800, null, IMAGE_QUALITY.HERO)}
                alt={artist.image.alt || artist.name}
                loading="eager"
                decoding="async"
              />
            </picture>
          </figure>
        )}

        <div class="artist-info">
          {artist.instrument && (
            <div class="artist-detail">
              <strong>üéµ Instrument:</strong>
              <span>{artist.instrument}</span>
            </div>
          )}

          {artist.country && (
            <div class="artist-detail">
              <strong>üåç Country:</strong>
              <span>{artist.country}</span>
            </div>
          )}
        </div>
      </header>

      {/* PageBuilder content from CMS */}
      {content && Array.isArray(content) && content.length > 0 && (
        <div class="artist-content">
          {content.map((block) => (
            <DynamicComponent key={block._key || block._id} block={block} />
          ))}
        </div>
      )}
    </article>
  </main>
</Layout>

<style>
  main {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
  }

  .breadcrumb {
    margin-bottom: 2rem;
  }

  .breadcrumb a {
    text-decoration: none;
  }

  article header {
    margin-bottom: 3rem;
  }

  h1 {
    font-size: 2.5rem;
    font-weight: bold;
    line-height: 1.2;
    margin-bottom: 2rem;
  }

  .artist-image {
    margin-bottom: 2rem;
  }

  .artist-image img {
    width: 100%;
    height: auto;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .artist-info {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid #dee2e6;
  }

  .artist-detail {
    display: flex;
    margin-bottom: 1rem;
    align-items: flex-start;
  }

  .artist-detail:last-child {
    margin-bottom: 0;
  }

  .artist-detail strong {
    min-width: 140px;
    margin-right: 1rem;
  }

  @media (max-width: 768px) {
    main {
      padding: 1rem;
    }

    h1 {
      font-size: 2rem;
    }

    .artist-info {
      padding: 1.5rem;
    }

    .artist-detail {
      flex-direction: column;
      align-items: flex-start;
    }

    .artist-detail strong {
      margin-bottom: 0.25rem;
      margin-right: 0;
    }
  }
</style>
