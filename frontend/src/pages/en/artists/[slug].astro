---
import Layout from "../../../layouts/Layout.astro";
import DynamicComponent from "../../../components/DynamicComponent.astro";
import { getMultilingualContent } from "../../../lib/utils/language.js";
import { getOptimizedImageUrl, IMAGE_QUALITY } from '../../../lib/imageHelpers';
import type { SanityDocument } from '@sanity/client';
import { loadQuery } from '../../../lib/sanity/loadQuery.js';
import { stegaClean } from '@sanity/client/stega';
import '../../../styles/event.css';

// Generate static paths for all artists
export async function getStaticPaths() {
  const { data: artists } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "artist" && defined(slug.current)]`,
  });

  return artists.map((artist) => {
    return {
      params: {
        slug: artist.slug.current,
      },
    };
  });
}

const { params } = Astro;

// Fetch the specific artist based on the slug parameter
const { data: artist } = await loadQuery({
  query: `*[_type == "artist" && slug.current == $slug][0]{
    _id,
    _type,
    name,
    excerpt_no,
    excerpt_en,
    instrument_no,
    instrument_en,
    "instrument": coalesce(instrument_en, instrument_no),
    country,
    "image": {
      "image": image{
        asset->,
        hotspot,
        crop
      },
      "alt": coalesce(imageAlt_en, imageAlt_no, image.alt),
      "credit": coalesce(imageCredit_en, imageCredit_no)
    },
    "slug": slug.current,
    content_no,
    content_en,
    instagram,
    facebook,
    spotify,
    youtube,
    websiteUrl,
    spotifyUrl,
    instagramUrl,
    seo
  }`,
  params,
});

if (!artist) {
  return Astro.redirect('/404');
}

// Get English content
const content = getMultilingualContent(artist, 'en') || artist.content_en;
---

<Layout title={`${artist.name} - Artist`}>
  <div class="container">
    <div class="event-page">
      <div class="event-info-grid">
        <div class="event-info-column">
          <header class="event-header">
            <h1 class="event-title">{stegaClean(artist.name)}</h1>
          </header>

          <div class="event-meta">
            {artist.instrument && (
              <div class="event-meta-item">
                <strong>Instrument:</strong> {stegaClean(artist.instrument)}
              </div>
            )}
            {artist.country && (
              <div class="event-meta-item">
                <strong>Country:</strong> {stegaClean(artist.country)}
              </div>
            )}
          </div>
        </div>

        {artist.image?.image && (
          <div class="event-image-column">
            <figure class="event-image artist-image-aspect">
              <img
                src={getOptimizedImageUrl(artist.image.image, 320, 400, IMAGE_QUALITY.CARD)}
                alt={stegaClean(artist.image.alt || artist.name)}
                loading="eager"
                decoding="async"
              />
            </figure>
          </div>
        )}
      </div>

      {content && Array.isArray(content) && content.length > 0 && (
        <div class="event-content">
          {content.map((block) => (
            <DynamicComponent key={block._key || block._id} block={block} />
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>

<style>
  /* Artist-specific image aspect ratio (4:5) and max width */
  .artist-image-aspect {
    aspect-ratio: 4 / 5;
    max-width: 380px;
  }
</style>
