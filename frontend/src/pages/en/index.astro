---
import Layout from '../../layouts/Layout.astro';
import DynamicComponent from '../../components/DynamicComponent.astro';
import { createDataService } from '../../lib/sanity/dataService.js';
import { getMultilingualContent } from "../../lib/utils/language.js";

// Create data service with Visual Editing support
const dataService = createDataService(Astro.request);

// Load homepage using data service
const homepage = await dataService.getHomepage();

const homepageTitle = homepage?.title || 'Home';

// Get appropriate content array
const content = getMultilingualContent(homepage, 'en') || homepage?.content_en || homepage?.content;

// Smart caching based on content type
if (homepage?.scheduledPeriod) {
  const timeUntilExpiry = new Date(homepage.scheduledPeriod.endDate).getTime() - Date.now();
  const cacheTime = Math.min(timeUntilExpiry / 1000, 300); // Max 5 minutes

  Astro.response.headers.set('Cache-Control', `public, max-age=${cacheTime}`);
} else {
  Astro.response.headers.set('Cache-Control', 'public, max-age=3600'); // 1 hour
}
---

<Layout title={homepageTitle}>
  <main class="container">
    {homepage ? (
      <div>
        <h1>{homepageTitle}</h1>


        {content && Array.isArray(content) && (
          <div>
            {content.map((block) => (
              <DynamicComponent key={block._key || block._id} block={block} />
            ))}
          </div>
        )}
      </div>
    ) : (
      <div>
        <h1>Welcome to the homepage</h1>
        <p>No homepage is configured yet. Go to Sanity Studio to create a homepage.</p>
      </div>
    )}
  </main>
</Layout>
