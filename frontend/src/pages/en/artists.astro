---
import ContentPageLayout from '../../layouts/ContentPageLayout.astro';
import CardGrid from '../../components/CardGrid.astro';
import { createDataService } from '../../lib/sanity/dataService.js';
import { getOptimizedImageUrl, getResponsiveSrcSet, IMAGE_QUALITY, RESPONSIVE_WIDTHS } from '../../lib/imageHelpers';

// Create data service with Visual Editing support
const dataService = createDataService(Astro.request);

// Fetch artists page content from artistPage schema
const artistsPage = await dataService.getArtistPage();

// Use only selected artists from artistPage
const artists = artistsPage?.selectedArtists || [];

// Fallback values
const pageTitle = artistsPage?.title || 'Artists';
---

<ContentPageLayout
  title={pageTitle}
  pageDocument={artistsPage}
>
  <CardGrid
    title="All artists"
    items={artists}
    gridType="artists"
    noResultsTitle="No artists published"
  >
    {artists.map((artist) => (
      <article class="artist-card card">
        <a href={`/en/artists/${artist.slug}`} class="artist-link">
          {artist.image?.image && (
            <div class="artist-image">
              <picture>
                <source
                  srcset={getResponsiveSrcSet(artist.image.image, RESPONSIVE_WIDTHS.MEDIUM, IMAGE_QUALITY.CARD)}
                  type="image/webp"
                  sizes="(max-width: 768px) 100vw, 400px"
                />
                <img
                  src={getOptimizedImageUrl(artist.image.image, 400, 400, IMAGE_QUALITY.CARD)}
                  alt={artist.image.alt || artist.name}
                  loading="lazy"
                  decoding="async"
                  class="artist-card-image"
                />
              </picture>
            </div>
          )}
          <div class="artist-content">
            <h3 class="artist-name">{artist.name}</h3>

            {artist.bio && (
              <p class="artist-bio">
                {artist.bio.length > 150 ? `${artist.bio.substring(0, 150)}...` : artist.bio}
              </p>
            )}

            {artist.genres && artist.genres.length > 0 && (
              <div class="artist-genres">
                {artist.genres.map((genre: any) => (
                  <span class="genre-tag">{genre.title}</span>
                ))}
              </div>
            )}
          </div>
        </a>
      </article>
    ))}
  </CardGrid>

  <style>
    /* Artist Card Specific Styles */
    .artist-card {
      container-type: inline-size;
      overflow: hidden;
      transition: box-shadow var(--transition-base);
    }

    .artist-link {
      text-decoration: none;
      display: block;
    }

    .artist-image {
      position: relative;
      height: clamp(250px, 30cqw, 400px);
      overflow: hidden;
      aspect-ratio: 4/5;
    }

    .artist-image picture {
      display: block;
      width: 100%;
      height: 100%;
    }

    .artist-card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .artist-content {
      padding: 0;
    }

    .artist-name {
      margin: 0 0 var(--space-2) 0;
      font-size: clamp(var(--font-size-lg), 4cqw, var(--font-size-xl));
      line-height: var(--line-height-tight);
    }

    .artist-bio {
      margin: 0 0 var(--space-3) 0;
      font-size: clamp(var(--font-size-sm), 3cqw, var(--font-size-base));
      line-height: var(--line-height-normal);
    }

    .artist-genres {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .genre-tag {
      padding: var(--space-1) var(--space-2);
      background: var(--color-surface);
      font-size: var(--font-size-xs);
      border: 1px solid var(--color-border);
    }

    /* Container Query Enhancements */
    @container (min-width: 300px) {
      .artist-name {
        font-size: var(--font-size-xl);
      }

      .artist-bio {
        font-size: var(--font-size-base);
      }
    }

    @container (min-width: 350px) {
      .artist-image {
        height: 250px;
      }
    }
  </style>

</ContentPageLayout>
