---
import ContentPageLayout from '../layouts/ContentPageLayout.astro';
import { createDataService } from '../lib/sanity/dataService.js';
import { getOptimizedImageUrl, getResponsiveSrcSet, IMAGE_QUALITY, RESPONSIVE_WIDTHS } from '../lib/imageHelpers';
import { stegaClean } from '@sanity/client/stega';
import '../styles/artists.css';

// Create data service with Visual Editing support
const dataService = createDataService(Astro.request);

// Hent artister-siden innhold fra artistPage schema
const artistsPage = await dataService.getArtistPage();

// Bruk kun valgte artister fra artistPage
const artists = artistsPage?.selectedArtists || [];

// Fallback values
const pageTitle = artistsPage?.title || 'Artister';

// Check if we have any artists
const hasArtists = artists.length > 0;
---

<ContentPageLayout
  title={pageTitle}
  excerpt={artistsPage?.excerpt}
  pageDocument={artistsPage}
>
  {hasArtists ? (
    <div class="artists-grid">
      {artists.map((artist) => (
        <article class="artist-card">
          <h3 class="artist-title">
            <a href={`/artister/${stegaClean(artist.slug)}`} class="artist-title-link">
              {stegaClean(artist.name)}
            </a>
          </h3>

          {artist.image?.image && (
            <div class="artist-image">
              <picture>
                <source
                  srcset={getResponsiveSrcSet(artist.image.image, RESPONSIVE_WIDTHS.MEDIUM, IMAGE_QUALITY.CARD)}
                  type="image/webp"
                  sizes="(max-width: 768px) 100vw, 320px"
                />
                <img
                  src={getOptimizedImageUrl(artist.image.image, 320, 400, IMAGE_QUALITY.CARD)}
                  alt={artist.image.alt || artist.name}
                  loading="lazy"
                  decoding="async"
                  class="artist-card-image"
                />
              </picture>
            </div>
          )}

          <div class="artist-info-box">
            <p class="artist-name">{stegaClean(artist.name)}</p>
            {artist.instrument && (
              <p class="artist-instrument">{stegaClean(artist.instrument)}</p>
            )}
          </div>
        </article>
      ))}
    </div>
  ) : (
    <div class="no-artists">
      <h3 class="no-artists-title">Ingen artister publisert</h3>
      <p class="no-artists-text">Kom tilbake senere for Ã¥ se vÃ¥re artister.</p>
    </div>
  )}
</ContentPageLayout>