---
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import { PortableText } from "astro-portabletext";
import Layout from '../../layouts/Layout.astro';
import Image from '../../components/Image.astro';
import { formatDateForLanguage } from '../../../../shared/utils/dates';

const EVENT_QUERY = `*[_type == "event" && slug.current == $slug][0]{
  _id,
  title,
  eventTime,
  eventDate->{
    title,
    date
  },
  venue->{
    title,
    linkText,
    linkUrl,
    address
  },
  genre->{
    title
  },
  artists[]->{
    name,
    instrument,
    country
  },
  image,
  buttonText,
  buttonUrl,
  buttonOpenInNewTab,
  content
}`;

const event = await sanityClient.fetch<SanityDocument>(EVENT_QUERY, Astro.params);

if (!event) {
  return Astro.redirect('/404');
}

export async function getStaticPaths() {
  const SLUGS_QUERY = `*[_type == "event" && defined(slug.current)]{
    "params": {"slug": slug.current}
  }`;
  return await sanityClient.fetch(SLUGS_QUERY);
}
---

<Layout title={`${event.title} - Sanity + Astro`}>
  <main 
    style="max-width: 800px; margin: 0 auto; padding: 2rem;"
    transition:name="main-content"
  >
    <a 
      href="/program" 
      style="color: #007acc; text-decoration: none; margin-bottom: 2rem; display: inline-block;"
    >
      â† Tilbake til program
    </a>
    
    <article>
      <header style="margin-bottom: 2rem;">
        <h1 
          style="margin: 0 0 1rem 0; color: #333;"
          transition:name={`event-title-${Astro.params.slug}`}
        >
          {event.title}
        </h1>
        
        <!-- Event image with shared transition -->
        {event.image && (
          <div 
            style="margin-bottom: 2rem; border-radius: 8px; overflow: hidden;"
            transition:name={`event-image-${Astro.params.slug}`}
          >
            <Image 
              image={event.image.image}
              alt={event.image.alt || event.title}
              caption=""
              credit=""
              size="full"
              aspectRatio="16:9"
              alignment="center"
            />
          </div>
        )}
        
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          {event.eventDate && (
            <p style="margin: 0 0 0.5rem 0;">
              <strong>ğŸ“… Dato:</strong> {event.eventDate.title} ({formatDateForLanguage(event.eventDate.date, 'no')})
            </p>
          )}
          
          {event.eventTime && (
            <p style="margin: 0 0 0.5rem 0;">
              <strong>ğŸ• Klokkeslett:</strong> {event.eventTime}
            </p>
          )}
          
          {event.venue && (
            <p style="margin: 0 0 0.5rem 0;">
              <strong>ğŸ¢ Sted:</strong> {event.venue.title}
              {event.venue.address && ` - ${event.venue.address}`}
            </p>
          )}
          
          {event.genre && (
            <p style="margin: 0 0 0.5rem 0;">
              <strong>ğŸ¼ Sjanger:</strong> {event.genre.title}
            </p>
          )}
          
          {event.artists && event.artists.length > 0 && (
            <div style="margin: 0 0 0.5rem 0;">
              <strong>ğŸµ Artister:</strong>
              <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                {event.artists.map((artist: any) => (
                  <li style="margin-bottom: 0.25rem;">
                    {artist.name} ({artist.instrument}, {artist.country})
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
        
        {event.buttonText && event.buttonUrl && (
          <a 
            href={event.buttonUrl} 
            target={event.buttonOpenInNewTab ? "_blank" : "_self"}
            rel={event.buttonOpenInNewTab ? "noopener noreferrer" : ""}
            style="
              display: inline-block;
              background: #0066cc;
              color: white;
              padding: 0.75rem 1.5rem;
              text-decoration: none;
              border-radius: 4px;
              font-weight: bold;
              margin-top: 1rem;
            "
          >
            {event.buttonText}
          </a>
        )}
      </header>
      
      {event.content && (
        <div style="line-height: 1.6;">
          <PortableText value={event.content} />
        </div>
      )}
    </article>
  </main>
</Layout>

<!-- Add View Transitions event listeners -->
<script>
  // Enhanced navigation with View Transitions
  document.addEventListener('astro:page-load', () => {
    console.log('Event detail page loaded with View Transitions');
  });

  document.addEventListener('astro:before-preparation', () => {
    console.log('Preparing to navigate...');
  });

  document.addEventListener('astro:after-swap', () => {
    console.log('Page content swapped successfully');
  });
</script>