---
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import { PortableText } from "astro-portabletext";
import Layout from '../../layouts/Layout.astro';
import Image from '../../components/Image.astro';
import { getCurrentLanguage, getLocalizedText, getLocalizedContent } from '../../lib/languageUtils';
import { formatDateForLanguage } from '../../../shared/utils/dates';

// Get current language from request
const currentLanguage = getCurrentLanguage(Astro.request);

const EVENT_QUERY = `*[_type == "event" && slug.current == $slug][0]{
  _id,
  title,
  titleEn,
  eventTime,
  eventDate->{
    title,
    date
  },
  venue->{
    title,
    titleEn,
    linkText,
    linkTextEn,
    linkUrl,
    address
  },
  genre->{
    title,
    titleEn
  },
  artists[]->{
    name,
    instrument,
    country
  },
  image,
  buttonText,
  buttonTextEn,
  buttonUrl,
  buttonOpenInNewTab,
  content,
  contentEn
}`;

const event = await sanityClient.fetch<SanityDocument>(EVENT_QUERY, Astro.params);

if (!event) {
  return Astro.redirect('/404');
}

// Localize content
const eventTitle = getLocalizedText(event.title, event.titleEn, currentLanguage);
const venueTitle = event.venue ? getLocalizedText(event.venue.title, event.venue.titleEn, currentLanguage) : '';
const venueLinkText = event.venue ? getLocalizedText(event.venue.linkText || event.venue.title, event.venue.linkTextEn, currentLanguage) : '';
const genreTitle = event.genre ? getLocalizedText(event.genre.title, event.genre.titleEn, currentLanguage) : '';
const buttonText = getLocalizedText(event.buttonText, event.buttonTextEn, currentLanguage);
const eventContent = getLocalizedContent(event.content, event.contentEn, currentLanguage);

export async function getStaticPaths() {
  const SLUGS_QUERY = `*[_type == "event" && defined(slug.current)]{
    "params": {"slug": slug.current}
  }`;
  return await sanityClient.fetch(SLUGS_QUERY);
}
---

<Layout title={`${eventTitle} - Sanity + Astro`} titleEn={event.titleEn ? `${event.titleEn} - Sanity + Astro` : undefined}>
  <main 
    style="max-width: 800px; margin: 0 auto; padding: 2rem;"
    transition:name="main-content"
  >
    <a 
      href="/program" 
      style="color: #007acc; text-decoration: none; margin-bottom: 2rem; display: inline-block;"
    >
      ← {currentLanguage === 'en' ? 'Back to program' : 'Tilbake til program'}
    </a>
    
    <article>
      <header style="margin-bottom: 2rem;">
        <h1 
          style="margin: 0 0 1rem 0; color: #333;"
          transition:name={`event-title-${Astro.params.slug}`}
        >
          {eventTitle}
        </h1>
        
        <!-- Event image with shared transition -->
        {event.image && (
          <div 
            style="margin-bottom: 2rem; border-radius: 8px; overflow: hidden;"
            transition:name={`event-image-${Astro.params.slug}`}
          >
            <Image 
              image={event.image.image}
              alt={event.image.alt || eventTitle}
              caption=""
              credit=""
              size="full"
              aspectRatio="16:9"
              alignment="center"
            />
          </div>
        )}
        
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          {event.eventDate && (
            <p style="margin: 0 0 0.5rem 0;">
              <strong>📅 {currentLanguage === 'en' ? 'Date:' : 'Dato:'}</strong> {event.eventDate.title} ({formatDateForLanguage(event.eventDate.date, currentLanguage)})
            </p>
          )}
          
          {event.eventTime && (
            <p style="margin: 0 0 0.5rem 0;">
              <strong>🕐 {currentLanguage === 'en' ? 'Time:' : 'Klokkeslett:'}</strong> {event.eventTime}
            </p>
          )}
          
          {event.venue && (
            <p style="margin: 0 0 0.5rem 0;">
              <strong>🏢 {currentLanguage === 'en' ? 'Venue:' : 'Sted:'}</strong> {venueTitle}
              {event.venue.address && ` - ${event.venue.address}`}
            </p>
          )}
          
          {event.genre && (
            <p style="margin: 0 0 0.5rem 0;">
              <strong>🎼 {currentLanguage === 'en' ? 'Genre:' : 'Sjanger:'}</strong> {genreTitle}
            </p>
          )}
          
          {event.artists && event.artists.length > 0 && (
            <div style="margin: 0 0 0.5rem 0;">
              <strong>🎵 {currentLanguage === 'en' ? 'Artists:' : 'Artister:'}</strong>
              <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                {event.artists.map((artist: any) => (
                  <li style="margin-bottom: 0.25rem;">
                    {artist.name} ({artist.instrument}, {artist.country})
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
        
        {buttonText && event.buttonUrl && (
          <a 
            href={event.buttonUrl} 
            target={event.buttonOpenInNewTab ? "_blank" : "_self"}
            rel={event.buttonOpenInNewTab ? "noopener noreferrer" : ""}
            style="
              display: inline-block;
              background: #0066cc;
              color: white;
              padding: 0.75rem 1.5rem;
              text-decoration: none;
              border-radius: 4px;
              font-weight: bold;
              margin-top: 1rem;
            "
          >
            {buttonText}
          </a>
        )}
      </header>
      
      {eventContent && (
        <div style="line-height: 1.6;">
          <PortableText value={eventContent} />
        </div>
      )}
    </article>
  </main>
</Layout>

<!-- Add View Transitions event listeners -->
<script>
  // Enhanced navigation with View Transitions
  document.addEventListener('astro:page-load', () => {
    console.log('Event detail page loaded with View Transitions');
  });

  document.addEventListener('astro:before-preparation', () => {
    console.log('Preparing to navigate...');
  });

  document.addEventListener('astro:after-swap', () => {
    console.log('Page content swapped successfully');
  });
</script> 