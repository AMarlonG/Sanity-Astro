---
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import Layout from '../layouts/Layout.astro';
import Image from '../components/Image.astro';
import PortableText from '../components/PortableText.astro';
import Heading from '../components/Heading.astro';
import Video from '../components/Video.astro';
import Button from '../components/Button.astro';
import Link from '../components/Link.astro';
import Quote from '../components/Quote.astro';
import Accordion from '../components/Accordion.astro';
import ContentScrollContainer from '../components/ContentScrollContainer.astro';
import ArtistScrollContainer from '../components/ArtistScrollContainer.astro';
import EventScrollContainer from '../components/EventScrollContainer.astro';
import { formatDateForLanguage } from '../../../shared/utils/dates';

// Hent program-siden innhold fra "Faste sider"
const programPage = await sanityClient.fetch<SanityDocument>(`
  *[_type == "page" && slug.current == "program"][0] {
    title,
    content
  }
`);

// Hent alle publiserte arrangementer
const events = await sanityClient.fetch<SanityDocument[]>(`
  *[_type == "event" && isPublished == true] | order(eventDate->date asc) {
    _id, 
    title,
    slug,
    eventTime{
      startTime,
      endTime
    },
    eventDate->{
      title,
      date
    },
    venue->{
      title
    },
    genre->{
      title
    },
    artists[]->{
      name
    },
    image
  }
`);

// Fallback values
const pageTitle = programPage?.title || 'Program';
---

<Layout title={`${pageTitle} - Sanity + Astro`}>
  <main class="container">
    <header class="page-header">
      <h1 class="page-title">
        {pageTitle}
      </h1>
    </header>
    
    <!-- Page content from schema -->
    {programPage?.content && Array.isArray(programPage.content) && (
      <div class="page-content">
        {programPage.content.map((block) => (
          <div key={block._key || block._id}>
            {block._type === 'portableTextBlock' && <PortableText content={block.content} />}
            {block._type === 'headingComponent' && <Heading level={block.level} text={block.text} id={block.id} />}
            {block._type === 'imageComponent' && <Image image={block.image} alt={block.alt} caption={block.caption} />}
            {block._type === 'videoComponent' && <Video url={block.url} title={block.title} thumbnail={block.thumbnail} />}
            {block._type === 'buttonComponent' && <Button text={block.text} style={block.style} size={block.size} action={block.action} />}
            {block._type === 'linkComponent' && <Link text={block.text} url={block.url} openInNewTab={block.openInNewTab} />}
            {block._type === 'quoteComponent' && <Quote quote={block.quote} author={block.author} />}
            {block._type === 'accordionComponent' && <Accordion title={block.title} content={block.content} />}
            {block._type === 'contentScrollContainer' && <ContentScrollContainer title={block.title} items={block.items} spacing={block.spacing} />}
            {block._type === 'artistScrollContainer' && <ArtistScrollContainer title={block.title} items={block.items} cardFormat={block.cardFormat} />}
            {block._type === 'eventScrollContainer' && <EventScrollContainer title={block.title} events={block.events} cardFormat={block.cardFormat} />}
            {/* Fallback for ukjent type */}
            {[ 'portableTextBlock', 'headingComponent', 'imageComponent', 'videoComponent', 'buttonComponent', 'linkComponent', 'quoteComponent', 'accordionComponent', 'contentScrollContainer', 'artistScrollContainer', 'eventScrollContainer' ].indexOf(block._type) === -1 && (
              <div>Ukjent komponent: {block._type}</div>
            )}
          </div>
        ))}
      </div>
    )}
    
    <!-- Events listing -->
    <section class="events-section">
      <h2 class="events-title">Alle arrangementer</h2>
      
      {events.length > 0 ? (
        <div class="events-grid">
          {events.map((event) => (
            <article 
              class="event-card card" 
              data-event-date={event.eventDate?.date}
            >
              <a href={`/program/${event.slug.current}`} class="event-link">
                {event.image && (
                  <div 
                    class="event-image"
                  >
                    <Image 
                      image={event.image.image}
                      alt={event.image.alt || event.title}
                      caption=""
                      credit=""
                      size="full"
                      aspectRatio="16:9"
                      alignment="center"
                      className="event-card-image"
                    />
                  </div>
                )}
                <div class="event-content">
                  <h3 
                    class="event-title"
                  >
                    {event.title}
                  </h3>
                  
                  <div class="event-meta">
                    {event.eventDate && (
                      <div class="event-detail">
                        <span class="event-label">Dato:</span>
                        <span>{event.eventDate.title} ({formatDateForLanguage(event.eventDate.date, 'no')})</span>
                      </div>
                    )}
                    
                    {event.eventTime && (
                      <div class="event-detail">
                        <span class="event-label">Tid:</span>
                        <span>{event.eventTime.startTime} - {event.eventTime.endTime}</span>
                      </div>
                    )}
                    
                    {event.venue && (
                      <div class="event-detail">
                        <span class="event-label">Sted:</span>
                        <span>{event.venue.title}</span>
                      </div>
                    )}
                    
                    {event.artists && event.artists.length > 0 && (
                      <div class="event-detail">
                        <span class="event-label">Artister:</span>
                        <span>{event.artists.map((artist: any) => artist.name).join(', ')}</span>
                      </div>
                    )}
                    
                    {event.genre && (
                      <div class="event-genre">
                        <span class="event-label">Sjanger:</span>
                        <span class="genre-name">{event.genre.title}</span>
                      </div>
                    )}
                  </div>
                </div>
              </a>
            </article>
          ))}
        </div>
      ) : (
        <div class="no-results">
          <h3 class="no-results-title">Ingen arrangementer publisert</h3>
          <p class="no-results-text">
            Sjekk tilbake senere for oppdateringer
          </p>
        </div>
      )}
    </section>
    
    <footer class="page-footer">
      <a href="/" class="back-link">
        ‚Üê Tilbake til forsiden
      </a>
    </footer>
  </main>

  <style>
    /* Page Layout */
    .page-header {
      margin-block-end: clamp(var(--space-5), 5vw, var(--space-8));
    }

    .page-title {
      margin: 0 0 var(--space-2) 0;
      color: var(--color-text-primary);
    }

    .page-content {
      margin-block-end: clamp(var(--space-6), 6vw, var(--space-9));
    }

    .events-section {
      margin-block-end: clamp(var(--space-6), 6vw, var(--space-9));
    }

    .events-title {
      margin: 0 0 var(--space-4) 0;
      color: var(--color-text-primary);
      font-size: var(--font-size-2xl);
    }

    .page-footer {
      margin-block-start: clamp(var(--space-6), 6vw, var(--space-9));
      padding-block-start: var(--space-6);
      border-block-start: 1px solid var(--color-border);
    }

    .back-link {
      color: var(--color-primary-500);
      text-decoration: none;
      font-weight: var(--font-weight-medium);
    }

    /* Intrinsic Events Grid */
    .events-grid {
      container-type: inline-size;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(100%, max(320px, 28ch)), 1fr));
      gap: clamp(var(--space-4), 3vw, var(--space-6));
    }

    @container (min-width: 600px) {
      .events-grid {
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 35ch), 1fr));
      }
    }

    @container (min-width: 900px) {
      .events-grid {
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 40ch), 1fr));
      }
    }

    /* Event Card */
    .event-card {
      container-type: inline-size;
      overflow: hidden;
      transition: box-shadow var(--transition-base);
    }

    .event-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .event-image {
      position: relative;
      height: clamp(180px, 20cqw, 240px);
      overflow: hidden;
      aspect-ratio: 16/9;
    }

    .event-card-image .image-container {
      margin: 0;
      height: 100%;
    }
    
    .event-card-image .image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
    }
    
    .event-card-image .image-caption {
      display: none;
    }

    .event-content {
      padding: 0; /* Let card handle padding with container queries */
    }

    .event-title {
      margin: 0 0 var(--space-3) 0;
      color: var(--color-text-primary);
      font-size: clamp(var(--font-size-lg), 4cqw, var(--font-size-xl));
      line-height: var(--line-height-tight);
    }

    .event-meta {
      color: var(--color-text-secondary);
      font-size: clamp(var(--font-size-sm), 3cqw, var(--font-size-base));
      line-height: var(--line-height-normal);
    }

    .event-detail {
      margin-block-end: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .event-label {
      font-weight: var(--font-weight-medium);
      flex-shrink: 0;
      min-width: 4rem;
    }

    .event-genre {
      margin-block-start: var(--space-3);
      padding-block-start: var(--space-3);
      border-block-start: 1px solid var(--color-border-light);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .genre-name {
      color: var(--color-text-disabled);
      font-size: var(--font-size-sm);
    }

    /* No Results */
    .no-results {
      text-align: center;
      padding: clamp(var(--space-6), 8vw, var(--space-9));
      color: var(--color-text-secondary);
    }

    .no-results-icon {
      font-size: clamp(var(--font-size-4xl), 10vw, var(--font-size-5xl));
      margin-block-end: var(--space-4);
    }

    .no-results-title {
      margin: 0 0 var(--space-4) 0;
      color: var(--color-text-primary);
    }

    .no-results-text {
      margin: 0;
      font-size: var(--font-size-lg);
    }

    /* Container Query Enhancements */
    @container (min-width: 350px) {
      .event-title {
        font-size: var(--font-size-xl);
      }
      
      .event-meta {
        font-size: var(--font-size-base);
      }
    }

    @container (min-width: 400px) {
      .event-image {
        height: 200px;
      }
    }
  </style>

</Layout>