---
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import EventFilter from '../components/EventFilter.astro';

// Hent filter-opsjoner (bare eventDates)
const eventDates = await sanityClient.fetch(`*[_type == "eventDate" && isActive == true] | order(date asc)`);

// Hent URL-parametere for initial state
const url = new URL(Astro.request.url);
const initialFilters = {
  eventDate: url.searchParams.get('eventDate') || '',
};

// Hent arrangementer basert p√• filtre
let eventsQuery = `*[_type == "event" && isPublished == true`;
const queryParams: any = {};

if (initialFilters.eventDate) {
  eventsQuery += ` && eventDate->date == $eventDate`;
  queryParams.eventDate = initialFilters.eventDate;
}

eventsQuery += `] | order(eventDate->date asc) {
  _id, 
  title, 
  slug,
  eventTime{
    startTime,
    endTime
  },
  eventDate->{
    title,
    date
  },
  venue->{
    title
  },
  genre->{
    title
  },
  artists[]->{
    name
  },
  image
}`;

const events = await sanityClient.fetch<SanityDocument[]>(eventsQuery, queryParams);
---

<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Program - Sanity + Astro</title>
  <!-- HTMX -->
  <script is:inline src="/htmx.min.js"></script>
  <script>
    // Aktiver HTMX logging for debugging
    htmx.logAll();
  </script>
</head>
<body>
  <main style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
    <h1>Program</h1>
    
    <!-- Filter-komponent -->
    <EventFilter 
      initialFilters={initialFilters}
      filterOptions={{
        eventDates
      }}
    />
    
    <!-- Resultater -->
    <div id="results-container">
      <div id="event-results">
        {events.length > 0 ? (
          <ul style="list-style: none; padding: 0;">
            {events.map((event) => (
              <li style="margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
                <a href={`/program/${event.slug.current}`} style="text-decoration: none; color: inherit;">
                  <h2 style="margin: 0 0 0.5rem 0; color: #333;">{event.title}</h2>
                  
                  <div style="margin-bottom: 0.5rem; color: #666;">
                    {event.eventDate && (
                      <p style="margin: 0 0 0.25rem 0;">
                        üìÖ {event.eventDate.title} ({new Date(event.eventDate.date).toLocaleDateString('nb-NO')})
                      </p>
                    )}
                    
                    {event.eventTime && (
                      <p style="margin: 0 0 0.25rem 0;">
                        üïê {event.eventTime.startTime} - {event.eventTime.endTime}
                      </p>
                    )}
                    
                    {event.venue && (
                      <p style="margin: 0 0 0.25rem 0;">
                        üè¢ {event.venue.title}
                      </p>
                    )}
                    
                    {event.artists && event.artists.length > 0 && (
                      <p style="margin: 0 0 0.25rem 0;">
                        üéµ {event.artists.map((artist: any) => artist.name).join(', ')}
                      </p>
                    )}
                    
                    {event.genre && (
                      <p style="margin: 0; color: #999; font-size: 0.9rem;">
                        üéº {event.genre.title}
                      </p>
                    )}
                  </div>
                </a>
              </li>
            ))}
          </ul>
        ) : (
          <p>Ingen arrangementer funnet med de valgte filtrene.</p>
        )}
      </div>
    </div>
    
    <p style="margin-top: 2rem;">
      <a href="/" style="color: #007acc;">‚Üê Tilbake til forsiden</a>
    </p>
  </main>

  <!-- 
    URL-OPPDATERING FOR FILTRERING
    ===============================
    
    Denne JavaScript-koden oppdaterer URL-en med query-parametere etter HTMX-filtrering,
    slik at URL-en blir bookmarkbar og delbar. Eksempel: /program?eventDate=2026-06-23
    
    Hvordan det fungerer:
    1. Lytter p√• 'htmx:afterRequest' event (n√•r filtrering er ferdig)
    2. Henter valgte filtre fra skjemaet
    3. Bygger ny URL med query-parametere
    4. Oppdaterer browser-historikk uten √• laste siden p√• nytt
    
    Dette gj√∏r at:
    - URL-en viser valgte filtre (bookmarkbar/delbar)
    - Refresh fungerer (siden leser URL-parametere)
    - Filtrering fungerer fortsatt (HTMX sender til API)
    - Browser-historikk fungerer (tilbake/frem-knapper)
  -->
  <script>
    // Lytter p√• HTMX-filtrering og oppdaterer URL-en
    document.addEventListener('htmx:afterRequest', function(event) {
      // Sjekk at dette er filtrerings-foresp√∏rselen (ikke andre HTMX-kall)
      if (event.detail.xhr.responseURL.includes('/api/filter-events')) {
        
        // Hent valgte filtre fra skjemaet
        const eventDateSelect = document.getElementById('eventDate');
        const selectedEventDate = eventDateSelect ? eventDateSelect.value : '';
        
        // Bygg ny URL med query-parametere
        const currentUrl = new URL(window.location);
        
        // Legg til eller fjern eventDate-parameter basert p√• valg
        if (selectedEventDate) {
          currentUrl.searchParams.set('eventDate', selectedEventDate);
        } else {
          currentUrl.searchParams.delete('eventDate');
        }
        
        // Oppdater browser-historikk uten √• laste siden p√• nytt
        // Dette gj√∏r URL-en bookmarkbar og delbar
        window.history.pushState({}, '', currentUrl.toString());
      }
    });

    // AUTOMATISK FILTRERING VED LASTING
    // ==================================
    //
    // Denne koden trigger automatisk filtrering n√•r siden lastes med URL-parametere,
    // slik at bookmarkbare URL-er fungerer. Eksempel: /program?eventDate=2026-06-23
    //
    // Hvordan det fungerer:
    // 1. Sjekker om URL har eventDate-parameter ved lasting
    // 2. Hvis ja, trigger filtrering for √• oppdatere resultatene
    // 3. Dette gj√∏r at direkte tilgang til URL med parametere fungerer
    //
    // Dette sikrer at:
    // - Bookmarkbare URL-er fungerer (refresh viser riktige resultater)
    // - Delbare lenker fungerer (andre kan klikke p√• lenke og se filtrerte resultater)
    // - Browser-historikk fungerer (tilbake/frem-knapper viser riktige resultater)
    // Bruk htmx.onLoad for √• sikre at HTMX er klar
    htmx.onLoad(function(content) {
      const url = new URL(window.location);
      const eventDate = url.searchParams.get('eventDate');
      
      console.log('htmx.onLoad - URL eventDate:', eventDate);
      
      // Hvis URL har eventDate-parameter, trigger filtrering
      if (eventDate) {
        const eventDateSelect = document.getElementById('eventDate');
        console.log('Found eventDateSelect:', eventDateSelect);
        console.log('Current value:', eventDateSelect?.value);
        console.log('Expected value:', eventDate);
        
                  if (eventDateSelect) {
            console.log('Triggering HTMX change event...');
            // Trigger filtrering for √• oppdatere resultatene
            htmx.find('#eventDate').dispatchEvent(new Event('change', { bubbles: true }));
          }
      }
    });
  </script>
</body>
</html> 