---
import ContentPageLayout from '../layouts/ContentPageLayout.astro';
import Image from '../components/Image.astro';
import { createDataService } from '../lib/sanity/dataService.js';
import { formatDateForLanguage } from '../../../shared/utils/dates';

// Create data service with Visual Editing support
const dataService = createDataService(Astro.request);

// Hent artikkelside-siden innhold
const articlePage = await dataService.getArticlePage();

// Get articles from articlePage and filter out null/undefined
const articles = (articlePage?.articles || []).filter(article => article != null);

// Fallback values
const pageTitle = articlePage?.title || 'Artikler';

// Check if we have any articles
const hasArticles = articles.length > 0;
---

<ContentPageLayout
  title={pageTitle}
  excerpt={articlePage?.excerpt}
  pageDocument={articlePage}
>
  {hasArticles ? (
    <div class="articles-grid">
      {articles.map((article) => (
        <article class="article-card card">
          <a href={`/artikler/${article.slug}`} class="article-link">
            {article.image && (
              <div class="article-image">
                <Image
                  image={article.image.image}
                  alt={article.image.alt || article.title}
                  caption=""
                  credit=""
                  size="full"
                  aspectRatio="16:9"
                  alignment="center"
                  className="article-card-image"
                />
              </div>
            )}
            <div class="article-content">
              <h3 class="article-title">{article.title}</h3>

              {article.subtitle && (
                <p class="article-subtitle">{article.subtitle}</p>
              )}

              {article.publishedAt && (
                <div class="article-meta">
                  <span class="article-date">
                    {formatDateForLanguage(article.publishedAt, 'no')}
                  </span>
                </div>
              )}
            </div>
          </a>
        </article>
      ))}
    </div>
  ) : (
    <div class="no-articles">
      <h3 class="no-articles-title">Ingen artikler publisert</h3>
      <p class="no-articles-text">Kom tilbake senere for å se våre artikler.</p>
    </div>
  )}

  <style>
    /* Articles Grid - Intrinsic responsive layout */
    .articles-grid {
      container-type: inline-size;
      display: grid;
      gap: clamp(var(--space-4), 3vw, var(--space-6));
      grid-template-columns: repeat(auto-fit, minmax(min(100%, max(350px, 30ch)), 1fr));
    }

    @container (min-width: 700px) {
      .articles-grid {
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 40ch), 1fr));
      }
    }

    @container (min-width: 1000px) {
      .articles-grid {
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 45ch), 1fr));
      }
    }

    /* Article Card Specific Styles */
    .article-card {
      container-type: inline-size;
      overflow: hidden;
      transition: box-shadow var(--transition-base);
    }

    .article-link {
      text-decoration: none;
      display: block;
    }

    .article-image {
      position: relative;
      height: clamp(180px, 20cqw, 240px);
      overflow: hidden;
      aspect-ratio: 16/9;
    }

    .article-card-image .image-container {
      margin: 0;
      height: 100%;
    }

    .article-card-image .image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .article-card-image .image-caption {
      display: none;
    }

    .article-content {
      padding: 0;
    }

    .article-title {
      margin: 0 0 var(--space-2) 0;
      font-size: clamp(var(--font-size-lg), 4cqw, var(--font-size-xl));
      line-height: var(--line-height-tight);
    }

    .article-subtitle {
      margin: 0 0 var(--space-3) 0;
      font-size: clamp(var(--font-size-sm), 3cqw, var(--font-size-base));
      line-height: var(--line-height-normal);
    }

    .article-meta {
      font-size: var(--font-size-sm);
    }

    .article-date {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* Container Query Enhancements */
    @container (min-width: 350px) {
      .article-title {
        font-size: var(--font-size-xl);
      }

      .article-subtitle {
        font-size: var(--font-size-base);
      }
    }

    @container (min-width: 400px) {
      .article-image {
        height: 200px;
      }
    }

    /* No Articles Empty State */
    .no-articles {
      text-align: center;
      padding: clamp(var(--space-6), 8vw, var(--space-9));
    }

    .no-articles-title {
      margin: 0 0 var(--space-4) 0;
    }

    .no-articles-text {
      margin: 0;
      font-size: var(--font-size-lg);
    }
  </style>

</ContentPageLayout>