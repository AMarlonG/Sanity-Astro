---
import Layout from '../layouts/Layout.astro';
import DynamicComponent from '../components/DynamicComponent.astro';
import { createDataService } from '../lib/sanity/dataService.js';

export async function getStaticPaths() {
  // In development, return empty array for on-demand rendering
  if (import.meta.env.DEV) {
    return [];
  }
  
  // In production, you might want to pre-generate paths
  // This would require fetching all published pages
  return [];
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// Create data service with Visual Editing support
const dataService = createDataService(Astro.request);

let page = null;

try {
  page = await dataService.getPageBySlug(slug);

  if (!page) {
    return Astro.redirect('/404');
  }
} catch (error) {
  console.error('Error loading page:', error);
  return Astro.redirect('/404');
}

const title = page.title;
const content = page.content;
---

<Layout title={title}>
  <main>
    <h1>{title}</h1>
    
    {content && Array.isArray(content) && (
      <div class="page-content">
        {content.map((block) => (
          <DynamicComponent key={block._key || block._id} block={block} />
        ))}
      </div>
    )}
  </main>
</Layout>

<style>
  .page-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    line-height: 1.6;
  }
  
  h1 {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    color: #333;
  }
  
  @media (max-width: 768px) {
    .page-content {
      padding: 1rem;
    }
    
    h1 {
      font-size: 2rem;
    }
  }
</style>