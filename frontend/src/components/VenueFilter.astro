---
interface Props {
  availableVenues: Array<{ slug: string; title: string }>;
  language: 'no' | 'en';
}

const { availableVenues, language } = Astro.props;

// Get current venue and date from URL (preserve date when filtering by venue)
const currentVenue = Astro.url.searchParams.get('venue') || '';
const currentDate = Astro.url.searchParams.get('date') || '';

// Build base URL and preserve date param if it exists
const buildUrl = (venueSlug?: string) => {
  const basePath = language === 'no' ? '/program' : '/en/program';
  const params = new URLSearchParams();

  if (currentDate) params.set('date', currentDate);
  if (venueSlug) params.set('venue', venueSlug);

  const queryString = params.toString();
  return queryString ? `${basePath}?${queryString}` : basePath;
};

// Build API URL with both date and venue params
const buildApiUrl = (venueSlug?: string) => {
  const params = new URLSearchParams();

  params.set('lang', language);
  if (currentDate) params.set('date', currentDate);
  if (venueSlug) params.set('venue', venueSlug);

  return `/api/filter-program?${params.toString()}`;
};
---

{availableVenues.length > 0 && (
  <div class="venue-filter">
    <div
      class="venue-filter-buttons"
      role="region"
      aria-label={language === 'no' ? 'Filtrer etter sted' : 'Filter by venue'}
      tabindex="0"
    >
      <a
        href={buildUrl()}
        class:list={['link-button', { active: !currentVenue }]}
        hx-get={buildApiUrl()}
        hx-target="#event-results"
        hx-swap="innerHTML show:none"
        hx-indicator="#filter-loading"
      >
        {language === 'no' ? 'Alle steder' : 'All venues'}
      </a>

      {availableVenues.map(venue => (
        <a
          href={buildUrl(venue.slug)}
          class:list={['link-button', { active: currentVenue === venue.slug }]}
          hx-get={buildApiUrl(venue.slug)}
          hx-target="#event-results"
          hx-swap="innerHTML show:none"
          hx-indicator="#filter-loading"
        >
          {venue.title}
        </a>
      ))}
    </div>
  </div>
)}
