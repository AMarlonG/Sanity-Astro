---
import { sanityClient } from "sanity:client";
import { getResponsiveImageSet, getOptimizedImageUrl, IMAGE_QUALITY, RESPONSIVE_WIDTHS } from '../lib/sanityImage';

interface Props {
  title?: string
  items?: any[]
  showScrollbar?: boolean
}

const {
  title,
  items = [],
  showScrollbar = false
} = Astro.props

// Hent faktiske artist-data fra referansene
let artistData = []
if (items && items.length > 0) {
  const artistIds = items.map((item: any) => item._ref).filter(Boolean)
  if (artistIds.length > 0) {
    const ARTIST_QUERY = `*[_type == "artist" && _id in $artistIds]{
      _id,
      _type,
      name,
      "slug": slug.current,
      excerpt_no,
      excerpt_en,
      "excerpt": coalesce(excerpt_no, excerpt_en),
      instrument_no,
      instrument_en,
      "instrument": coalesce(instrument_no, instrument_en),
      country,
      "image": {
        "image": image{
          asset->{
            _id,
            url,
            metadata {
              dimensions {
                width,
                height,
                aspectRatio
              },
              lqip,
              blurHash,
              palette {
                dominant {
                  background,
                  foreground
                }
              }
            }
          },
          hotspot,
          crop
        },
        "alt": coalesce(imageAlt_no, imageAlt_en, image.alt),
        "credit": coalesce(imageCredit_no, imageCredit_en)
      },
      publishingStatus,
      scheduledPeriod,
      instagram,
      facebook,
      spotify,
      youtube,
      websiteUrl,
      spotifyUrl,
      instagramUrl,
      seo
    }`
    artistData = await sanityClient.fetch(ARTIST_QUERY, { artistIds })
  }
}

// CSS-klasser basert p√• props
const containerClass = 'artist-scroll-container'
const scrollbarClass = showScrollbar ? '' : 'hide-scrollbar'
---

<section class={`${containerClass} ${scrollbarClass}`}>
  {title && <h3 class="artist-scroll-title">{title}</h3>}
  <ul class="artist-list">
    {artistData.map((artist) => {
        if (!artist) return null

        const artistName = artist.name || ''
        const artistImage = artist.image?.image || null
        const artistImageAlt = artist.image?.alt || artistName || ''
        const artistInstrument = artist.instrument || ''
        const artistCountry = artist.country || ''
        const artistSlug = artist.slug || ''

        // Generate responsive image sources (4:5 aspect ratio)
        const aspectRatio = 4 / 5
        const responsiveImages = artistImage
          ? getResponsiveImageSet(artistImage, [240, 280, 320], ['webp', 'jpg'], aspectRatio, IMAGE_QUALITY.CARD)
          : null

        // Fallback URL for browsers without picture support
        const fallbackUrl = artistImage
          ? getOptimizedImageUrl(artistImage, 280, 350, IMAGE_QUALITY.CARD)
          : null

        return (
          <li class="artist-item">
            <a href={`/artister/${artistSlug}`} class="artist-card-link">
              <article class="artist-card">
                {artistImage && responsiveImages && fallbackUrl && (
                  <div class="artist-image">
                    <picture>
                      {responsiveImages
                        .filter((format) => format.srcset.length > 0)
                        .map((format) => (
                        <source
                          srcset={format.srcset}
                          sizes="(max-width: 768px) 240px, 280px"
                          type={`image/${format.format}`}
                        />
                      ))}
                      <img
                        src={fallbackUrl}
                        alt={artistImageAlt}
                        width="280"
                        height="350"
                        loading="lazy"
                        decoding="async"
                        style="aspect-ratio: 4/5; object-fit: cover;"
                      />
                    </picture>
                  </div>
                )}
                <div class="artist-content">
                  <h4 class="artist-name">{artistName}</h4>
                  {artistInstrument && <p class="artist-instrument">{artistInstrument}</p>}
                  {artistCountry && <p class="artist-country">{artistCountry}</p>}
                </div>
              </article>
            </a>
          </li>
        )
      })}
  </ul>
</section>

<style>
  .artist-scroll-container {
    width: min(100ch, 100% - 4rem);
    margin-inline: auto;
    margin-block: 2rem;
  }

  .artist-scroll-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .artist-list {
    display: flex;
    gap: 1rem;
    list-style: none;
    margin: 0;
    padding: 0.5rem 0;
    overflow-x: auto;
  }

  .artist-item {
    flex-shrink: 0;
  }

  .artist-card-link {
    text-decoration: none;
    display: block;
  }

  .artist-card {
    background: white;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    aspect-ratio: 4/5;
    width: 280px;
  }

  .artist-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .artist-image {
    flex: 1;
    overflow: hidden;
  }

  .artist-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .artist-content {
    padding: 0.75rem;
    background: white;
  }

  .artist-name {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    line-height: 1.2;
  }

  .artist-instrument {
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
  }

  .artist-country {
    font-size: 0.85rem;
  }

  /* Hide scrollbar */
  .hide-scrollbar .artist-list {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .hide-scrollbar .artist-list::-webkit-scrollbar {
    display: none;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .artist-list {
      gap: 0.75rem;
    }

    .artist-card {
      width: 240px;
    }
  }
</style> 