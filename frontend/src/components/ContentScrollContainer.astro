---
import DynamicComponent from './DynamicComponent.astro'
import { getResponsiveImageSet, getOptimizedImageUrl, IMAGE_QUALITY } from '../lib/sanityImage'
import { stegaClean } from '@sanity/client/stega'

interface Props {
  title?: string
  items?: any[]
  showScrollbar?: boolean
  className?: string
  _key?: string
  _type?: string
}

const {
  title,
  items = [],
  showScrollbar = false,
  className = '',
  _key,
  _type,
} = Astro.props

// CSS classes
const scrollbarClass = showScrollbar ? '' : 'hide-scrollbar'

// Sanity Visual Editing attributes
const sanityAttributes = _key ? { 'data-sanity': `${_type}.${_key}` } : {}
---

<section class={`content-scroll-container ${scrollbarClass} ${className}`} {...sanityAttributes}>
  {title && <h2 class="scroll-container-title">{title}</h2>}

  <ul class="scroll-list">
    {items.map((item) => {
      if (!item) return null

      // Handle imageComponent items with inline rendering
      if (item._type === 'imageComponent' && item.image) {
        const aspectRatio = 4 / 5 // Default 4:5 for scroll containers
        const imageSource = item.image
        const imageAlt = stegaClean(item.alt || '')
        const imageCredit = item.credit ? stegaClean(item.credit) : null

        // Generate responsive image set
        const responsiveImages = imageSource
          ? getResponsiveImageSet(imageSource, [200, 240, 280, 320], ['webp', 'jpg'], aspectRatio, IMAGE_QUALITY.CARD)
          : null

        // Fallback URL for browsers without picture support
        const fallbackUrl = imageSource
          ? getOptimizedImageUrl(imageSource, 280, 350, IMAGE_QUALITY.CARD)
          : null

        return (
          <li class="scroll-item">
            {imageSource && responsiveImages && fallbackUrl ? (
              <figure class="scroll-image-figure">
                <picture>
                  {responsiveImages
                    .filter((format) => format.srcset.length > 0)
                    .map((format) => (
                    <source
                      srcset={format.srcset}
                      sizes="(max-width: 768px) 200px, (max-width: 1024px) 240px, 280px"
                      type={`image/${format.format}`}
                    />
                  ))}
                  <img
                    src={fallbackUrl}
                    alt={imageAlt}
                    width="280"
                    height="350"
                    loading="lazy"
                    decoding="async"
                    class="scroll-image"
                  />
                </picture>
                {imageCredit && (
                  <figcaption class="image-credit">{imageCredit}</figcaption>
                )}
              </figure>
            ) : (
              <div class="image-placeholder">
                <span>Bilde ikke tilgjengelig</span>
              </div>
            )}
          </li>
        )
      }

      // Handle other component types with DynamicComponent
      return (
        <li class="scroll-item">
          <DynamicComponent block={item} />
        </li>
      )
    })}
  </ul>
</section>

<style>
  .content-scroll-container {
    width: min(100ch, 100% - 4rem);
    margin-inline: auto;
    margin-block: 3rem;
  }

  .scroll-container-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .scroll-list {
    display: flex;
    gap: 1.5rem;
    list-style: none;
    margin: 0;
    padding: 0.5rem 0 1rem 0;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  }

  .scroll-item {
    flex-shrink: 0;
    width: 280px; /* Desktop width */
    border-radius: 8px;
    overflow: hidden;
    position: relative;
  }

  /* Image figure styling */
  .scroll-image-figure {
    margin: 0;
    width: 100%;
    aspect-ratio: 4 / 5;
    position: relative;
  }

  .scroll-image-figure picture {
    display: block;
    width: 100%;
    height: 100%;
  }

  .scroll-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .image-credit {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
    color: white;
    font-size: 0.75rem;
    text-align: right;
  }

  .image-placeholder {
    width: 100%;
    aspect-ratio: 4 / 5;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    border: 2px dashed #ddd;
    color: #666;
  }

  /* Make other child components (non-images) fill the scroll item */
  .scroll-item > :global(:not(.scroll-image-figure):not(.image-placeholder)) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Hide scrollbar */
  .hide-scrollbar .scroll-list {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
  }

  .hide-scrollbar .scroll-list::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }

  /* Tablet: Slightly smaller cards */
  @media (max-width: 1024px) {
    .scroll-item {
      width: 240px;
    }

    .scroll-list {
      gap: 1.25rem;
    }
  }

  /* Mobile: Smaller cards */
  @media (max-width: 768px) {
    .content-scroll-container {
      margin: 2rem 0;
    }

    .scroll-container-title {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    .scroll-item {
      width: 200px;
    }

    .scroll-list {
      gap: 1rem;
    }
  }

  /* Accessibility */
  .scroll-item:focus-within {
    outline: 2px solid #0066cc;
    outline-offset: 2px;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .scroll-list {
      scroll-behavior: auto;
    }
  }
</style> 