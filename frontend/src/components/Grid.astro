---
import DynamicComponent from './DynamicComponent.astro'

export interface Props {
  title?: string
  columns: '2' | '3'
  items: any[]
  aspectRatio?: '4:5' | '1:1'
  gap?: 'small' | 'medium' | 'large'
  className?: string
  _key?: string
  _type?: string
}

const {
  title,
  columns = '3',
  items = [],
  aspectRatio = '4:5',
  gap = 'medium',
  className = '',
  _key,
  _type,
} = Astro.props

// Map gap values to CSS variables
const gapMap = {
  small: '1rem',
  medium: '2rem',
  large: '3rem',
}

const gapValue = gapMap[gap] || gapMap.medium

// Convert aspectRatio string to CSS value
const aspectMap: Record<string, string> = {
  '4:5': '4 / 5',
  '1:1': '1 / 1',
}
const aspectValue = aspectMap[aspectRatio] || '4 / 5'

// Calculate if we have an odd number of items for centering logic
const itemCount = items.length
const columnsNumber = parseInt(columns)
const isOdd = itemCount % columnsNumber !== 0

// Sanity Visual Editing attributes
const sanityAttributes = _key ? { 'data-sanity': `${_type}.${_key}` } : {}
---

<section class={`grid-component content-wide ${className}`} {...sanityAttributes}>
  {title && <h2 class="grid-title">{title}</h2>}

  <div
    class={`grid-container ${isOdd ? 'has-odd-items' : ''}`}
    data-columns={columns}
    data-layout-context="grid"
    style={`--grid-gap: ${gapValue}; --grid-aspect-ratio: ${aspectValue};`}
  >
    {items.map((item, index) => (
      <div class={`grid-item ${isOdd && index >= itemCount - (itemCount % columnsNumber) ? 'bottom-row' : ''}`}>
        <DynamicComponent block={item} />
      </div>
    ))}
  </div>
</section>

<style>
  .grid-component {
    margin: 3rem 0;
    max-width: 100%;
  }

  .grid-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 2rem;
    text-align: center;
  }

  .grid-container {
    display: grid;
    gap: var(--grid-gap, 2rem);
    width: 100%;
    align-items: stretch;

    /* Container query context - allows children to adapt to available space */
    container-type: inline-size;
    container-name: grid-layout;
  }

  /* Desktop: 2 or 3 columns based on data attribute */
  .grid-container[data-columns='2'] {
    grid-template-columns: repeat(2, 1fr);
  }

  .grid-container[data-columns='3'] {
    grid-template-columns: repeat(3, 1fr);
  }

  /* All grid items use configurable aspect ratio */
  .grid-item {
    width: 100%;
    aspect-ratio: var(--grid-aspect-ratio, 4 / 5);
    overflow: hidden;
    border-radius: 8px;
    position: relative;
    display: flex;
    flex-direction: column;
    min-height: 300px; /* Prevent tiny boxes */

    /* Performance optimizations */
    contain: layout style paint;
    content-visibility: auto;
  }

  /* Centering logic for odd number of items */
  /* When we have odd items, the bottom row should be centered and not enlarged */
  .grid-container.has-odd-items {
    justify-items: center;
  }

  /* Bottom row items maintain their size, don't stretch */
  .grid-container.has-odd-items .grid-item.bottom-row {
    max-width: 100%;
  }

  /* Media content: Fill and crop */
  .grid-item > :global(.image-container),
  .grid-item > :global(.image-wrapper),
  .grid-item > :global([data-component="video"]) {
    width: 100%;
    height: 100%;
    flex: 1;
  }

  .grid-item > :global(.image-wrapper img),
  .grid-item > :global(.image) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Components that fill grid space and respect aspect ratio */
  .grid-item > :global([data-component="quote"]),
  .grid-item > :global([data-component="video"]) {
    width: 100%;
    height: 100%;
    flex: 1;
  }

  /* Quote component: Scrollable within fixed height */
  .grid-item > :global([data-component="quote"]) {
    overflow-y: auto;
    height: 100%;
    padding: 1.5rem;

    /* Custom scrollbar styling */
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
  }

  .grid-item > :global([data-component="quote"])::-webkit-scrollbar {
    width: 8px;
  }

  .grid-item > :global([data-component="quote"])::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
  }

  /* Tablet: Reduce to 2 columns for 3-column layouts */
  @media (max-width: 1024px) {
    .grid-container[data-columns='3'] {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* Mobile: Stack vertically (1 column) */
  @media (max-width: 768px) {
    .grid-container[data-columns='2'],
    .grid-container[data-columns='3'] {
      grid-template-columns: 1fr;
    }

    .grid-title {
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .grid-component {
      margin: 2rem 0;
    }
  }

  /* Responsive gap adjustments */
  @media (max-width: 768px) {
    .grid-container {
      --grid-gap: max(1rem, var(--grid-gap) * 0.5);
    }
  }

  /* Accessibility */
  .grid-item:focus-within {
    outline: 2px solid #0066cc;
    outline-offset: 2px;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .grid-item {
      transition: none;
    }
  }

  /* Print styles */
  @media print {
    .grid-container {
      display: block;
    }

    .grid-item {
      page-break-inside: avoid;
      margin-bottom: 1rem;
      aspect-ratio: auto;
      overflow: visible;
      contain: none;
      min-height: auto;
    }

    .grid-item > :global([data-component="quote"]) {
      overflow-y: visible;
      height: auto;
    }
  }
</style>
